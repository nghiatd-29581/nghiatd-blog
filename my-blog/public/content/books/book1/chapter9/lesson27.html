<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>B√†i 27: Deployment & K·∫øt n·ªëi Frontend ‚Äì Rust cho C# Developer</title>
</head>
<body>

<div class="lesson-container">
  <p class="lesson-intro">
    Ch√†o m·ª´ng b·∫°n ƒë·∫øn v·ªõi B√†i 27 - B√†i h·ªçc cu·ªëi c√πng c·ªßa h√†nh tr√¨nh n√†y.<br><br>
    N·∫øu ƒë√¢y l√† m·ªôt game nh·∫≠p vai, th√¨ b·∫°n ƒëang ƒë·ª©ng tr∆∞·ªõc c·ª≠a ·∫£i cu·ªëi c√πng ƒë·ªÉ ƒë√°nh b·∫°i Boss v√† ho√†n th√†nh game.<br><br>
    Trong C#, khi xong code, b·∫°n ch·ªçn Publish -> IIS ho·∫∑c Docker -> Azure/AWS.<br><br>
    Trong Solana, b·∫°n Deploy -> Blockchain (Devnet/Mainnet).<br><br>
    Tuy nhi√™n, vi·ªác k·∫øt n·ªëi gi·ªØa Frontend (React/JS) v√† Blockchain th∆∞·ªùng l√† n∆°i ph√°t sinh nhi·ªÅu l·ªói nh·∫•t do s·ª± b·∫•t ƒë·ªìng b·ªô v·ªÅ phi√™n b·∫£n (Version mismatch) v√† c·∫•u h√¨nh v√≠.<br><br>
    H√£y ƒëi th·∫≠t ch·∫≠m b√†i n√†y. ƒê√¢y l√† c√¢y c·∫ßu n·ªëi code c·ªßa b·∫°n v·ªõi th·∫ø gi·ªõi th·ª±c.
  </p>

  <h1 class="lesson-part">PH·∫¶N 4: D·ª∞ √ÅN T·ªêT NGHI·ªÜP</h1>
  <h2 class="lesson-chapter">CH∆Ø∆†NG 9: V√ç CRYPTO MINI & DEX</h2>
  <h3 class="lesson-title">B√ÄI 27: DEPLOYMENT & K·∫æT N·ªêI FRONTEND</h3>

  <h4 class="lesson-section">1. Chu·∫©n b·ªã: Chuy·ªÉn nh√† t·ª´ Localnet sang Devnet</h4>
  
  <p class="lesson-text">ƒê·∫øn gi·ªù, ch√∫ng ta to√†n ch·∫°y tr√™n localnet (m·∫°ng n·ªôi b·ªô m√°y b·∫°n). Kh√¥ng ai th·∫•y code c·ªßa b·∫°n c·∫£. Gi·ªù ta chuy·ªÉn sang devnet (m·∫°ng th·ª≠ nghi·ªám c√¥ng khai c·ªßa Solana - gi·ªëng m√¥i tr∆∞·ªùng Staging/UAT).</p>

  <p class="lesson-text"><strong>B∆∞·ªõc 1: C·∫•u h√¨nh CLI sang Devnet</strong><br>
  M·ªü terminal:</p>
  <pre class="lesson-code lesson-code-bash">solana config set --url devnet</pre>

  <p class="lesson-text"><strong>B∆∞·ªõc 2: T·∫°o v√≠ Deployer m·ªõi (Khuy√™n d√πng)</strong><br>
  T·∫°i sao? V√¨ v√≠ local c·ªßa b·∫°n c√≥ th·ªÉ ch·ª©a key test lung tung. N√™n t·∫°o m·ªôt v√≠ m·ªõi s·∫°ch s·∫Ω cho Devnet.</p>
  <pre class="lesson-code lesson-code-bash">solana-keygen new -o devnet-wallet.json</pre>

  <p class="lesson-text">L∆∞u √Ω: N√≥ s·∫Ω in ra 12 t·ª´ kh√≥a (Seed phrase). Tuy·ªát ƒë·ªëi kh√¥ng d√πng v√≠ n√†y ch·ª©a ti·ªÅn th·∫≠t (Mainnet).</p>

  <p class="lesson-text"><strong>B∆∞·ªõc 3: N·∫°p ti·ªÅn (Airdrop)</strong><br>
  ƒê·ªÉ deploy code l√™n m·∫°ng, b·∫°n c·∫ßn tr·∫£ ph√≠ thu√™ ch·ªó (Rent).</p>
  <pre class="lesson-code lesson-code-bash">solana airdrop 2 devnet-wallet.json</pre>

  <p class="lesson-text">‚ö†Ô∏è C·∫£nh b√°o l·ªói: Devnet Airdrop th∆∞·ªùng xuy√™n b·ªã l·ªói "Rate limit" ho·∫∑c "Faucet dry".<br>
  * Gi·∫£i ph√°p: N·∫øu l·ªánh tr√™n th·∫•t b·∫°i, h√£y copy ƒë·ªãa ch·ªâ v√≠ (Public Key) v√† v√†o trang web Solana Faucet ƒë·ªÉ xin SOL th·ªß c√¥ng.</p>

  <h4 class="lesson-section">2. Quy tr√¨nh Deploy "Chu·∫©n ch·ªâ" (Tr√°nh l·ªói Program ID)</h4>
  
  <p class="lesson-text">ƒê√¢y l√† l·ªói kinh ƒëi·ªÉn nh·∫•t m√† 90% ng∆∞·ªùi m·ªõi (v√† c·∫£ ng∆∞·ªùi c≈©) ƒë·ªÅu d√≠nh.<br>
  L·ªói: Account used is not a program ho·∫∑c Verification failed.<br>
  L√Ω do: Khi b·∫°n anchor build l·∫ßn ƒë·∫ßu, Anchor t·∫°o ra m·ªôt Keypair m·ªõi ng·∫´u nhi√™n cho Program. Nh∆∞ng trong code lib.rs (macro declare_id!) v√† file Anchor.toml v·∫´n ƒëang l∆∞u ID c≈© ho·∫∑c ID m·∫∑c ƒë·ªãnh.</p>

  <p class="lesson-text"><strong>Quy tr√¨nh ƒë·ªìng b·ªô ID (L√†m ch√≠nh x√°c t·ª´ng b∆∞·ªõc):</strong></p>
  <ol class="lesson-list">
    <li>Build l·∫ßn 1 (ƒë·ªÉ l·∫•y key):<br>
       <pre class="lesson-code lesson-code-bash">anchor build</pre></li>
    <li>L·∫•y Program ID m·ªõi sinh ra:<br>
       Ch·∫°y l·ªánh:<br>
       <pre class="lesson-code lesson-code-bash">solana address -k target/deploy/rusty_dex-keypair.json</pre>
       (Thay rusty_dex b·∫±ng t√™n project c·ªßa b·∫°n).<br>
       Gi·∫£ s·ª≠ n√≥ ra: BuX7...zk9</li>
    <li>C·∫≠p nh·∫≠t ID v√†o Code (QUAN TR·ªåNG):<br>
       * M·ªü lib.rs: S·ª≠a declare_id!("BuX7...zk9");<br>
       * M·ªü Anchor.toml: T√¨m d√≤ng [programs.devnet] (ho·∫∑c localnet), s·ª≠a rusty_dex = "BuX7...zk9".</li>
    <li>Build l·∫ßn 2 (ƒë·ªÉ code kh·ªõp v·ªõi key):<br>
       <pre class="lesson-code lesson-code-bash">anchor build</pre>
       L√Ω do: L·∫ßn build n√†y s·∫Ω nh√∫ng c√°i ID BuX7...zk9 v√†o trong file binary .so. N·∫øu kh√¥ng build l·∫°i, code tr√™n chu·ªói s·∫Ω mang ID kh√°c v·ªõi ƒë·ªãa ch·ªâ deploy -> L·ªói ngay.</li>
    <li>Deploy:<br>
       <pre class="lesson-code lesson-code-bash">anchor deploy --provider.cluster devnet --provider.wallet devnet-wallet.json</pre></li>
  </ol>

  <p class="lesson-text">N·∫øu th·∫•y d√≤ng ch·ªØ: "Deploy success" k√®m theo Program Id. Ch√∫c m·ª´ng! Code c·ªßa b·∫°n ƒë√£ s·ªëng tr√™n Internet.</p>

  <h4 class="lesson-section">3. Frontend Integration: Hi·ªÉu v·ªÅ IDL</h4>
  
  <p class="lesson-text"><strong>Kh√°i ni·ªám:</strong></p>
  <ul class="lesson-list">
    <li><strong>C#:</strong> Khi b·∫°n vi·∫øt API, b·∫°n c√≥ Swagger (OpenAPI) ƒë·ªÉ Frontend bi·∫øt c√≥ h√†m g√¨, tham s·ªë ra sao.</li>
    <li><strong>Solana:</strong> Ch√∫ng ta c√≥ IDL (Interface Description Language).</li>
  </ul>

  <p class="lesson-text">Khi b·∫°n anchor build, n√≥ sinh ra file target/idl/rusty_dex.json. File JSON n√†y m√¥ t·∫£ to√†n b·ªô c·∫•u tr√∫c h√†m swap, initialize...<br>
  Frontend c·∫ßn file n√†y ƒë·ªÉ bi·∫øt c√°ch n√≥i chuy·ªán v·ªõi Blockchain.</p>

  <p class="lesson-text"><strong>Setup Frontend:</strong><br>
  T√¥i s·∫Ω kh√¥ng h∆∞·ªõng d·∫´n setup React t·ª´ ƒë·∫ßu (qu√° d√†i). H√£y gi·∫£ s·ª≠ b·∫°n d√πng Next.js ho·∫∑c Vite React.</p>

  <p class="lesson-text">C√†i ƒë·∫∑t th∆∞ vi·ªán c·∫ßn thi·∫øt:</p>
  <pre class="lesson-code lesson-code-bash">npm install @solana/web3.js @coral-xyz/anchor @solana/wallet-adapter-react @solana/wallet-adapter-react-ui @solana/wallet-adapter-wallets</pre>

  <h4 class="lesson-section">4. Code k·∫øt n·ªëi Frontend (Step-by-Step)</h4>
  
  <p class="lesson-text">T·∫°o m·ªôt file utils/program.ts (ho·∫∑c t∆∞∆°ng t·ª±).</p>

  <p class="lesson-text"><strong>B∆∞·ªõc 1: Import IDL v√† Type</strong><br>
  Copy file target/types/rusty_dex.ts (Anchor t·ª± sinh ra) v√†o th∆∞ m·ª•c frontend c·ªßa b·∫°n.</p>

  <p class="lesson-text"><strong>B∆∞·ªõc 2: Vi·∫øt h√†m k·∫øt n·ªëi</strong></p>
  <pre class="lesson-code lesson-code-ts">import { AnchorProvider, Program, web3 } from "@coral-xyz/anchor";
import { useAnchorWallet, useConnection } from "@solana/wallet-adapter-react";
import idl from "./idl/rusty_dex.json"; // Copy file JSON IDL v√†o ƒë√¢y
import { RustyDex } from "./types/rusty_dex"; // Copy file Type v√†o ƒë√¢y

const PROGRAM_ID = new web3.PublicKey("BuX7...zk9"); // ID b·∫°n v·ª´a deploy

export const useProgram = () => {
  const { connection } = useConnection();
  const wallet = useAnchorWallet();

  const getProgram = () => {
    if (!wallet) return null;

    // 1. T·∫°o Provider
    // Provider = Connection (RPC) + Wallet (Ng∆∞·ªùi k√Ω)
    // Gi·ªëng ConnectionString + UserCredentials trong C#
    const provider = new AnchorProvider(connection, wallet, {
      preflightCommitment: "processed",
    });

    // 2. T·∫°o Program Object
    // ƒê√¢y ch√≠nh l√† "Client" ƒë·ªÉ g·ªçi RPC
    const program = new Program<RustyDex>(
      idl as any, 
      provider
    ); // anchor.workspace.RustyDex kh√¥ng ch·∫°y ·ªü frontend, ph·∫£i d√πng new Program()

    return program;
  };

  return { getProgram };
};</pre>

  <h4 class="lesson-section">5. G·ªçi h√†m Swap t·ª´ UI (React Component)</h4>
  
  <p class="lesson-text">V√≠ d·ª• trong SwapComponent.tsx:</p>
  <pre class="lesson-code lesson-code-ts">import { useState } from 'react';
import { useProgram } from '../utils/program';
import { web3, BN } from "@coral-xyz/anchor";
import { getAssociatedTokenAddress } from "@solana/spl-token";

export const SwapComponent = () => {
  const { getProgram } = useProgram();
  const [isLoading, setIsLoading] = useState(false);

  const handleSwap = async () => {
    const program = getProgram();
    if (!program) return alert("Vui l√≤ng k·∫øt n·ªëi v√≠!");

    try {
      setIsLoading(true);

      // Hardcode v√≠ d·ª• c√°c ƒë·ªãa ch·ªâ (Trong th·ª±c t·∫ø b·∫°n ph·∫£i l·∫•y t·ª´ config ho·∫∑c input)
      const mintA = new web3.PublicKey("..."); 
      const mintB = new web3.PublicKey("...");
      const poolPda = new web3.PublicKey("..."); // ƒê·ªãa ch·ªâ Pool PDA
      const vaultA = new web3.PublicKey("...");
      const vaultB = new web3.PublicKey("...");

      // T√¨m v√≠ token c·ªßa ng∆∞·ªùi d√πng
      // L∆∞u √Ω: wallet.publicKey l√† v√≠ ƒëang k·∫øt n·ªëi
      const userSource = await getAssociatedTokenAddress(mintA, program.provider.publicKey);
      const userDest = await getAssociatedTokenAddress(mintB, program.provider.publicKey);

      // G·ªçi Smart Contract
      // C√∫ ph√°p y h·ªát l√∫c vi·∫øt Test (B√†i 26)
      const tx = await program.methods
        .swap(new BN(1000000)) // Swap 1 token (n·∫øu decimals = 6)
        .accounts({
          pool: poolPda,
          user: program.provider.publicKey, // Anchor t·ª± l·∫•y v√≠ ƒëang connect l√†m signer
          userSourceToken: userSource,
          userDestinationToken: userDest,
          vaultSource: vaultA,
          vaultDestination: vaultB,
          tokenProgram: web3.TOKEN_PROGRAM_ID, // ƒê·ª´ng qu√™n c√°i n√†y
        })
        .rpc(); // G·ª≠i transaction ƒëi

      console.log("Giao d·ªãch th√†nh c√¥ng! Hash:", tx);
      alert("Swap th√†nh c√¥ng!");

    } catch (error) {
      console.error("L·ªói:", error);
      alert("Swap th·∫•t b·∫°i: " + error.toString());
    } finally {
      setIsLoading(false);
    }
  };

  return (
    <button onClick={handleSwap} disabled={isLoading}>
      {isLoading ? "Swapping..." : "Swap A to B"}
    </button>
  );
};</pre>

  <h4 class="lesson-section">6. C√°c l·ªói th∆∞·ªùng g·∫∑p (Troubleshooting)</h4>
  
  <p class="lesson-text">ƒê√¢y l√† ph·∫ßn quan tr·ªçng nh·∫•t ƒë·ªÉ c·ª©u b·∫°n kh·ªèi nh·ªØng ƒë√™m m·∫•t ng·ªß.</p>
  <ol class="lesson-list">
    <li><strong>L·ªói "Signature verification failed":</strong><br>
       * Nguy√™n nh√¢n: Th∆∞·ªùng do Seeds trong code Frontend (ƒë·ªÉ t√¨m PDA) kh√¥ng kh·ªõp v·ªõi code Rust. Ho·∫∑c b·∫°n truy·ªÅn sai account (V√≠ d·ª•: truy·ªÅn Vault A v√†o ch·ªó Vault B).<br>
       * Check: Ki·ªÉm tra k·ªπ th·ª© t·ª± seeds: [b"pool", mintA, mintB] hay [b"pool", mintB, mintA]?</li>
    <li><strong>L·ªói "0x1 (Insufficient Lamports)":</strong><br>
       * Nguy√™n nh√¢n: V√≠ ng∆∞·ªùi d√πng h·∫øt SOL l√†m ph√≠ gas.<br>
       * Fix: Airdrop th√™m SOL.</li>
    <li><strong>L·ªói "Account does not exist":</strong><br>
       * Nguy√™n nh√¢n: User ch∆∞a c√≥ V√≠ Token (ATA) cho Token B.<br>
       * Fix: ·ªû Frontend, tr∆∞·ªõc khi swap, ph·∫£i check xem User c√≥ ATA B ch∆∞a. N·∫øu ch∆∞a, ph·∫£i b·∫Øn th√™m m·ªôt instruction createAssociatedTokenAccount v√†o transaction swap (ho·∫∑c l√†m 1 transaction ri√™ng).</li>
    <li><strong>Version Mismatch (R·∫•t hay g·∫∑p):</strong><br>
       * N·∫øu b·∫°n d√πng Anchor v0.29 nh∆∞ng c√†i @coral-xyz/anchor v0.30 ·ªü frontend -> C√≥ th·ªÉ l·ªói.<br>
       * L·ªùi khuy√™n: H√£y c·ªë g·∫Øng gi·ªØ version c·ªßa CLI v√† th∆∞ vi·ªán JS t∆∞∆°ng ƒë·ªìng nhau.</li>
  </ol>

  <h3 class="lesson-summary">T·ªîNG K·∫æT KH√ìA H·ªåC: T·ª™ C# SANG RUST</h3>

  <div class="lesson-summary-box">
    <p class="lesson-text"><strong>Ch√∫c m·ª´ng b·∫°n! üéâüéâüéâ</strong><br>
    B·∫°n ƒë√£ ƒëi t·ª´ con s·ªë 0 v·ªÅ Blockchain, t·ª´ m·ªôt C# Developer quen v·ªõi class, interface, garbage collector ƒë·ªÉ tr·ªü th√†nh m·ªôt Rustacean vi·∫øt code qu·∫£n l√Ω b·ªô nh·ªõ th·ªß c√¥ng v√† x√¢y d·ª±ng ·ª©ng d·ª•ng phi t·∫≠p trung.</p>
    <p class="lesson-text"><strong>Nh√¨n l·∫°i h√†nh tr√¨nh:</strong></p>
    <ol class="lesson-list">
      <li>Ph·∫ßn 1 & 2: B·∫°n v·∫≠t l·ªôn v·ªõi Borrow Checker, Ownership - Nh·ªØng kh√°i ni·ªám kh√≥ nh·∫•t c·ªßa Rust.</li>
      <li>Ph·∫ßn 3: B·∫°n l√†m quen v·ªõi Solana, Account Model.</li>
      <li>Ph·∫ßn 4: B·∫°n t·ª± tay x√¢y d·ª±ng m·ªôt S√†n giao d·ªãch (DEX) - M·ªôt trong nh·ªØng ·ª©ng d·ª•ng ph·ª©c t·∫°p nh·∫•t c·ªßa DeFi.</li>
    </ol>
    <p class="lesson-text"><strong>B∆∞·ªõc ti·∫øp theo l√† g√¨?</strong><br>
    Quy·ªÉn s√°ch n√†y ch·ªâ l√† t·∫•m v√© nh·∫≠p m√¥n. Th·∫ø gi·ªõi Blockchain c√≤n r·∫•t r·ªông l·ªõn:</p>
    <ul class="lesson-list">
      <li>NFTs: Metaplex, Candy Machine.</li>
      <li>Oracles: Chainlink, Pyth (L·∫•y d·ªØ li·ªáu gi√° th·∫≠t t·ª´ ngo√†i ƒë·ªùi).</li>
      <li>Security: H·ªçc c√°ch audit code, t·∫•n c√¥ng Re-entrancy.</li>
    </ul>
    <p class="lesson-text">T√¥i hy v·ªçng t√†i li·ªáu n√†y ƒë√£ gi√∫p b·∫°n v∆∞·ª£t qua n·ªói s·ª£ h√£i ban ƒë·∫ßu khi ti·∫øp c·∫≠n Rust. H√£y ƒë√≥ng g√≥i ki·∫øn th·ª©c n√†y, vi·∫øt l·∫°i th√†nh s√°ch, chia s·∫ª cho c·ªông ƒë·ªìng.<br>
    <em>"The best way to learn is to teach."</em></p>
  </div>

  <p class="lesson-ending">
    (Ch√∫c m·ª´ng b·∫°n ƒë√£ ho√†n th√†nh to√†n b·ªô kh√≥a h·ªçc! üéâ<br>
    B·∫°n x·ª©ng ƒë√°ng t·ª± h√†o v·ªÅ b·∫£n th√¢n.<br>
    B√¢y gi·ªù, h√£y ra ngo√†i v√† x√¢y d·ª±ng th·ª© g√¨ ƒë√≥ tuy·ªát v·ªùi b·∫±ng Rust v√† Solana nh√©!)
  </p>
</div>

</body>
</html>